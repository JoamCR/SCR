<!DOCTYPE html>
<html>
<head>
    <title>Previsualizar Reporte</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/global.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/estilos.css">
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 class="mb-0">Previsualizar Reporte #{{ servicio['id'] }}</h1>
            <a href="{{ url_for('index') }}" class="btn-regresar btn-form-main inicio-top-right ms-3" title="Inicio">Inicio</a>
        </div>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    <!-- Previsualizacion
         form method="POST">
            <div class="mb-3">
                <label for="membrete_nombre">Nombre del Taller</label>
                <input type="text" name="membrete_nombre" id="membrete_nombre" class="form-control" value="{{ membrete.nombre }}" required title="Nombre del taller" placeholder="Ejemplo: Taller XYZ">
            </div>
            <div class="mb-3">
                <label for="membrete_direccion">Dirección</label>
                <input type="text" name="membrete_direccion" id="membrete_direccion" class="form-control" value="{{ membrete.direccion }}" required title="Dirección del taller" placeholder="Ejemplo: Calle 123, Ciudad">
            </div>
            <div class="mb-3">
                <label for="membrete_telefono">Teléfono</label>
                <input type="text" name="membrete_telefono" id="membrete_telefono" class="form-control" value="{{ membrete.telefono }}" required title="Teléfono del taller" placeholder="Ejemplo: 5551234567">
            </div>
            <div class="mb-3">
                <label for="departamento">Departamento</label>
                <input type="text" name="departamento" id="departamento" class="form-control" value="{{ membrete.departamento if membrete.departamento is defined else '' }}" title="Departamento" placeholder="Ejemplo: Sistemas">
            </div>
            <div class="mb-3">
                <label for="dependencia">Dependencia</label>
                <input type="text" name="dependencia" id="dependencia" class="form-control" value="{{ membrete.dependencia if membrete.dependencia is defined else '' }}" title="Dependencia" placeholder="Ejemplo: Universidad">
            </div>
            <div class="mb-3">
                <label for="celular">Celular</label>
                <input type="text" name="celular" id="celular" class="form-control" value="{{ membrete.celular if membrete.celular is defined else '' }}" title="Celular" placeholder="Ejemplo: 5559876543">
            </div>
            
            <div class="d-flex gap-2 mb-3">
                <button type="submit" name="guardar_membrete" class="btn-aceptar btn-form-main" title="Guardar Membrete">Guardar Membrete</button>
                <button type="submit" name="generar_pdf" class="btn-reporte-final btn-form-main" title="Generar PDF">Generar PDF</button>
                <a href="{{ url_for('tecnico.panel') }}" class="btn-cancelar btn-form-main" title="Regresar al Panel Técnico">Regresar</a>
            </div>
          
        </form>
    -->

        <!-- Previsualización -->
        <div class="reporte-preview" style="background-color: white; padding: 30px 40px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 900px; margin: 40px auto;">
            <h1 style="color: #1E3A8A; text-align: center; margin-bottom: 25px;">Orden de Servicio</h1>
            <div class="form-section" style="border: 1px solid #ddd; padding: 20px; border-radius: 6px; margin-bottom: 20px;">
                <h2 style="color: #333; border-bottom: 2px solid #1E3A8A; padding-bottom: 10px;">Datos Generales</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div><label>No. de Orden</label><input type="text" value="{{ servicio['id'] }}" readonly class="reporte-input"></div>
                    <div><label>Fecha</label><input type="text" value="{{ servicio['fecha_entrega'] or datetime.now().strftime('%d/%m/%Y') }}" readonly class="reporte-input"></div>
                    <div><label>Usuario</label><input type="text" value="{{ servicio['tecnico_actual'] or 'Sin asignar' }}" readonly class="reporte-input"></div>
                </div>
            </div>
            <div class="form-section" style="border: 1px solid #ddd; padding: 20px; border-radius: 6px; margin-bottom: 20px;">
                <h2 style="color: #333; border-bottom: 2px solid #1E3A8A; padding-bottom: 10px;">Información del Cliente</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div style="grid-column: 1 / -1;"><label>Cliente</label><input type="text" value="{{ servicio['nombre'] }} {{ servicio['primer_apellido'] }} {{ servicio['segundo_apellido'] }}" readonly class="reporte-input"></div>
                        <div style="grid-column: 1 / -1;"><label>Dirección</label><input type="text" value="" readonly class="reporte-input"></div>
                        <div style="grid-column: 1 / -1;"><label>Departamento</label><input type="text" value="" readonly class="reporte-input"></div>
                        <div style="grid-column: 1 / -1;"><label>Dependencia</label><input type="text" value="" readonly class="reporte-input"></div>
                        <div><label>Teléfono</label><input type="text" value="{{ servicio['telefono'] }}" readonly class="reporte-input"></div>
                </div>
            </div>
            <div class="form-section" style="border: 1px solid #ddd; padding: 20px; border-radius: 6px; margin-bottom: 20px;">
                <h2 style="color: #333; border-bottom: 2px solid #1E3A8A; padding-bottom: 10px;">Datos del Equipo</h2>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th>Cant.</th>
                            <th>Descripción</th>
                            <th>Marca</th>
                            <th>Modelo</th>
                            <th>No. Serie</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td>{{ servicio['tipo_equipo'] }}</td>
                            <td>{{ servicio['marca'] }}</td>
                            <td>{{ servicio['modelo'] }}</td>
                            <td>{{ servicio['serie'] or 'No especificada' }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="form-section" style="border: 1px solid #ddd; padding: 20px; border-radius: 6px; margin-bottom: 20px;">
                <h2 style="color: #333; border-bottom: 2px solid #1E3A8A; padding-bottom: 10px;">Diagnóstico y Servicio</h2>
                <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                    <label>Fallas y Observaciones</label>
                    <textarea readonly class="reporte-textarea">{{ servicio['notas'] or 'Sin notas' }}</textarea>
                </div>
                <div style="grid-column: 1 / -1; margin-top: 15px;">
                    <label>Servicio Realizado</label>
                    <textarea readonly class="reporte-textarea">{{ servicio['servicio'] }}</textarea>
                </div>
            </div>
            <!-- Sección de Imágenes del Servicio (separada) -->
            <div class="form-section" style="border: 1px solid #ddd; padding: 20px; border-radius: 6px; margin-bottom: 20px;">
                <h2 style="color: #333; border-bottom: 2px solid #1E3A8A; padding-bottom: 10px;">Imágenes del Servicio</h2>
                <div class="imagenes-servicio-list">
                    {% set fotos = [
                        ('Foto Inicial', servicio['foto_inicial']),
                        ('Foto Durante Servicio', servicio['foto_servicio']),
                        ('Foto Final', servicio['foto_final'])
                    ] %}
                    {% set hay_foto = false %}
                    {% for label, ruta_completa in fotos %}
                        {% if ruta_completa %}
                            {% set hay_foto = true %}
                            <div class="imagenes-servicio-item">
                                <div>
                                    <p class="photo-indicator">{{ label }}</p>
                                    <img src="/{{ ruta_completa }}" alt="{{ label }}" class="imagenes-servicio-img" onerror="this.style.display='none'; this.parentElement.insertAdjacentHTML('beforeend', '<div class=\'text-danger\' style=\'text-align:center;\'><span style=\'font-size:2em;\'>&#9888;</span><br>No se pudo cargar la imagen</div>');">
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                    {% if not hay_foto %}
                        <span class="imagenes-servicio-empty">No hay imágenes cargadas para este servicio.</span>
                    {% endif %}
                </div>
            </div>
        </div>
        <form method="POST" class="mt-4 d-flex justify-content-center gap-btns">
            <!-- Campos ocultos para enviar los datos del membrete al generar el PDF -->
            <input type="hidden" name="membrete_nombre" value="{{ membrete.get('nombre', '') }}">
            <input type="hidden" name="membrete_direccion" value="{{ membrete.get('direccion', '') }}">
            <input type="hidden" name="membrete_telefono" value="{{ membrete.get('telefono', '') }}">
            <input type="hidden" name="departamento" value="{{ membrete.get('departamento', '') }}">
            <input type="hidden" name="dependencia" value="{{ membrete.get('dependencia', '') }}">
            <input type="hidden" name="celular" value="{{ membrete.get('celular', '') }}">

            <button type="submit" name="generar_pdf" class="btn-reporte-final btn-form-main" title="Generar PDF">Generar PDF</button>
            <a href="{{ url_for('tecnico.panel') }}" class="btn-cancelar btn-form-main" title="Regresar al Panel Técnico">Regresar</a>
        </form>
    </div>
    
</body>
</html>